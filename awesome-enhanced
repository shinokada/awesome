#!/usr/bin/env bash
# shellcheck disable=SC2154
# Enhanced awesome package manager

version="0.6.0"
awesome_dir="$HOME/.local/share/awesome"
bin_dir="$HOME/.local/share/bin"

myrealpath() {
    local LINK REALPATH
    local OURPWD=$PWD
    cd "$(dirname "$1")" || exit
    LINK=$(readlink "$(basename "$1")")
    while [ "$LINK" ]; do
        cd "$(dirname "$LINK")" || exit
        LINK=$(readlink "$(basename "$1")")
    done
    REALPATH="$PWD/$(basename "$1")"
    cd "$OURPWD" || exit
    echo "$REALPATH"
}

# Determine script directory
if [[ $0 =~ ^\./.*-enhanced$ || $0 = "./awesome-enhanced" ]]; then
    # Running enhanced version directly
    script_path=$(myrealpath "$0")
elif [[ -z $(which awesome 2>/dev/null) || $0 = "./awesome" ]]; then
    # Running from local using ./awesome and awesome is not installed
    script_path=$(myrealpath "$0")
else
    # awesome is installed
    script_path=$(myrealpath "$(which awesome)")
fi

script_dir="${script_path%/*}"

# Try to load enhanced lib first, fallback to original
if [[ -f "${script_dir}/utils/lib-enhanced" ]]; then
    # shellcheck disable=SC1091
    source "${script_dir}/utils/lib-enhanced"
elif [[ -f "${script_dir}/utils/lib" ]]; then
    # shellcheck disable=SC1091
    source "${script_dir}/utils/lib"
else
    echo "Error: Cannot find lib or lib-enhanced in ${script_dir}/utils/" >&2
    exit 1
fi

# ============================================================================
# CONFIRMATION & UTILITY FUNCTIONS
# ============================================================================

fn_confirmRemove() {
    local package=$1
    read -rp "Do you want to remove $package? yes/y or no/n   " PANS
    ans=$(echo "$PANS" | cut -c 1-1 | tr "[:lower:]" "[:upper:]")
    echo "$ans"
}

fn_search_main() {
    repo=$1
    if [[ -d "$awesome_dir/$repo" ]]; then
        cd "$awesome_dir/$repo" || return
        if [[ -n $2 ]]; then
            script_name=$2
        else
            script_name="$repo"
        fi
        IFS= read -r -d '' repo < <(find . '(' -name "${script_name##*/}" -o -name "${script_name##*/}.sh" ')' -print0)

        if [[ $repo ]]; then
            printf '%s\n' "$(basename "$repo")"
        else
            return 1
        fi
    else
        printf "${RED}%s${RESET}\n" "The repo and script names are different." >&2
        printf "${RED}%s${RESET}\n" "Use, for example: awesome link tldr-sh-client tldr" >&2
        exit 1
    fi
}

fn_remove_dir() {
    repo=$1
    src_path=$2
    
    if [[ $src_path == "$awesome_dir" || $src_path == "$bin_dir" ]]; then
        printf "${RED}%s${RESET}\n" "We don't remove $awesome_dir nor $bin_dir directory."
        return
    fi

    slash_num=$(slashes "$src_path")
    if [ "$slash_num" = 6 ]; then
        path_to_delete="$src_path"
    elif [ "$slash_num" = 7 ]; then
        path_to_delete=$(first "$src_path")
    else
        echo "Unknown src path."
        exit
    fi
    
    printf "${CYAN}%s${RESET}\n" "Removing the ${src_path} directory ..."
    rm -rf "$path_to_delete" || exit
    printf "${GREEN}%s${RESET}\n" "$repo directory removed."
    log_operation "remove" "$repo" "success"
    return 0
}

fn_remove_symlink() {
    if [[ -z $1 ]]; then
        printf "${RED}%s${RESET}\n" "Specify the repo to remove." >&2
        exit 1
    fi
    repo=$1
    
    if [[ $repo = 'awesome' ]]; then
        printf "${RED}%s${RESET}\n" "==> Please don't remove the awesome link."
        exit 1
    fi
    
    if no_symlink "$repo" "$bin_dir"; then
        printf "${YELLOW}%s${RESET}\n" "No symlink found for $repo"
        exit
    else
        cd "$bin_dir" || exit
        rm "${repo}" 2>/dev/null || exit
        printf "${GREEN}%s${RESET}\n" "Symlink removed."
        log_operation "unlink" "$repo" "success"
    fi
    exit
}

fn_add_symlink() {
    if [[ -z $1 ]]; then
        printf "${RED}%s${RESET}\n" "Specify the repo to add." >&2
        exit 1
    else
        repo_base=$1
    fi
    
    if [[ -n $2 ]]; then
        script_name=$2
    else
        script_name="$repo_base"
    fi
    
    printf "${CYAN}%s${RESET}\n" "Searching ..."
    
    if [[ $(ls "$awesome_dir/$repo_base" 2>/dev/null) =~ $script_name ]]; then
        file_name=$(fn_search_main "$repo_base" "$script_name") || exit 1
        echo "$file_name"
        create_symlink "${awesome_dir}" "${repo_base}" "${script_name}" "${bin_dir}" || exit
        printf "${GREEN}%s${RESET}\n" "Symlink added."
    else
        printf "${RED}%s${RESET}\n" "No $script_name in $awesome_dir"
        exit 1
    fi
    exit
}

# ============================================================================
# INSTALL FUNCTION (Enhanced)
# ============================================================================

fn_install() {
    if [[ -z $1 ]]; then
        printf "${RED}%s${RESET}\n" "You need to specify the GitHub repo URL." >&2
        exit 1
    fi

    # Check network before attempting install
    if ! check_network; then
        exit 1
    fi

    slash_num=$(slashes "$2")
    if [[ $slash_num = 0 ]]; then
        repo_script "$1" "$2"
        cd "$awesome_dir" || exit
        
        if [[ -n $repo_name ]]; then
            printf "${CYAN}%s${RESET}\n" "Installing $repo_name..."
            
            # Use enhanced clone function with retry
            if [[ $3 ]]; then
                # Branch specified - need to handle differently
                if git_clone_with_retry "${repo_link}" "${repo_name}"; then
                    cd "$repo_name" || exit
                    git checkout "$3" || {
                        printf "${RED}%s${RESET}\n" "Failed to checkout branch $3"
                        exit 1
                    }
                    cd ..
                else
                    exit 1
                fi
            else
                git_clone_with_retry "${repo_link}" "${repo_name}" || exit 1
            fi
            
            printf "${GREEN}%s${RESET}\n" "Cloning done."
            
            # Create manifest
            create_manifest "${repo_name}" "${repo_link}" "${3:-latest}"
        fi
        
        create_symlink "${awesome_dir}" "${repo_name}" "${script_name}" "${bin_dir}" || exit
        repo=$repo_name
        log_operation "install" "$repo_name" "success"
        
    elif [[ $slash_num = 1 ]]; then
        cd "$awesome_dir" || exit
        user_repo=$1
        repo_name=$(second "$user_repo")
        sub=$2
        script_repo=$(first "$sub")
        script_name=$(second "$sub")
        
        if ! no_symlink "$script_name" "$bin_dir"; then
            printf "${RED}%s${RESET}\n" "Link exists. Exiting..." >&2
            exit 1
        fi
        
        repo_script "$1" "$script_name"
        
        if [[ ! -d "${awesome_dir}/${repo_name}" ]]; then
            echo "Cloning repository..."
            if [[ $3 ]]; then
                git_clone_with_retry "${repo_link}" "${repo_name}" || exit 1
                cd "$repo_name" || exit
                git checkout "$3" || exit
                cd ..
            else
                git_clone_with_retry "${repo_link}" "${repo_name}" || exit 1
            fi
            printf "${GREEN}%s${RESET}\n" "Cloning done."
            create_manifest "${repo_name}" "${repo_link}" "${3:-latest}"
        fi
        
        create_symlink "${awesome_dir}" "${repo_name}/${script_repo}" "${script_name}" "${bin_dir}" || exit
        repo=$script_name
        log_operation "install" "$script_name" "success"
    else
        printf "${RED}%s${RESET}\n" "You can't install sub/sub/script."
        exit 1
    fi
    
    printf "${GREEN}%s${RESET}\n" "${repo_name}/${script_name} installation completed." >&2
    echo "Try ${repo} -h or which ${repo}." >&2
}

# ============================================================================
# REMOVE FUNCTION
# ============================================================================

fn_rm() {
    cd "$awesome_dir" || exit
    repo=$1
    
    if [[ $repo = "awesome" ]]; then
        printf "${RED}%s${RESET}\n" "If you want to uninstall awesome, visit:"
        printf "${RED}%s${RESET}\n" "https://github.com/shinokada/awesome"
        exit
    fi
    
    path=$(myrealpath "$bin_dir/$repo")
    src_path=$(src_path "$path")
    S_NUM=$(slashes "$path")
    
    if [ "$S_NUM" -eq 8 ]; then
        dirpath=$(second "$(first "$src_path")")
    else
        dirpath=$(second "$src_path")
    fi
    
    if (($(same_src_path "$dirpath" "$bin_dir") > 1)); then
        printf "${YELLOW}%s${RESET}\n" "Another app is using the same repo."
        printf "${YELLOW}%s${RESET}\n" "Not deleting the repo."
    else
        fn_remove_dir "$repo" "$src_path"
    fi
    
    fn_remove_symlink "$repo"
    exit
}

# ============================================================================
# UPDATE FUNCTIONS
# ============================================================================

fn_update() {
    repo=$1
    if [[ -z $repo ]]; then
        printf "${RED}%s${RESET}\n" "Package name is missing."
        exit 1
    fi
    
    if [[ $(ls "$bin_dir" 2>/dev/null) =~ $repo ]]; then
        symlink_dir="$(myrealpath "$bin_dir/$repo")"
        dir="${symlink_dir%/*}"
        cd "$dir" || exit
        
        printf "${CYAN}%s${RESET}\n" "Updating $repo..."
        if git pull; then
            printf "${GREEN}%s${RESET}\n" "$repo updated."
            log_operation "update" "$repo" "success"
        else
            printf "${RED}%s${RESET}\n" "$repo update failed."
            log_operation "update" "$repo" "failed"
            exit 1
        fi
        exit
    else
        printf "${RED}%s${RESET}\n" "You don't have ${repo}." >&2
        exit 2
    fi
}

# ============================================================================
# HEALTH CHECK (NEW)
# ============================================================================

fn_doctor() {
    printf "${BOLD}${CYAN}%s${RESET}\n\n" "=== Awesome Health Check ==="
    
    local issues=0
    
    # Check Git installation
    printf "${BOLD}%s${RESET}\n" "1. Checking Git installation..."
    if command -v git &>/dev/null; then
        printf "${GREEN}%s${RESET}\n" "   ✓ Git is installed ($(git --version))"
    else
        printf "${RED}%s${RESET}\n" "   ✗ Git is not installed"
        ((issues++))
    fi
    
    # Check network
    printf "\n${BOLD}%s${RESET}\n" "2. Checking network connectivity..."
    if check_network; then
        printf "${GREEN}%s${RESET}\n" "   ✓ Network connection OK"
    else
        printf "${RED}%s${RESET}\n" "   ✗ Cannot reach GitHub"
        ((issues++))
    fi
    
    # Check directories
    printf "\n${BOLD}%s${RESET}\n" "3. Checking directories..."
    if [[ -d "$awesome_dir" ]]; then
        printf "${GREEN}%s${RESET}\n" "   ✓ Awesome directory exists: $awesome_dir"
    else
        printf "${YELLOW}%s${RESET}\n" "   ! Awesome directory missing: $awesome_dir"
        ((issues++))
    fi
    
    if [[ -d "$bin_dir" ]]; then
        printf "${GREEN}%s${RESET}\n" "   ✓ Bin directory exists: $bin_dir"
    else
        printf "${YELLOW}%s${RESET}\n" "   ! Bin directory missing: $bin_dir"
        ((issues++))
    fi
    
    # Check disk space
    printf "\n${BOLD}%s${RESET}\n" "4. Checking disk space..."
    if check_disk_space; then
        printf "${GREEN}%s${RESET}\n" "   ✓ Disk space OK"
    else
        printf "${YELLOW}%s${RESET}\n" "   ! Low disk space warning"
    fi
    
    # Check broken symlinks
    printf "\n${BOLD}%s${RESET}\n" "5. Checking for broken symlinks..."
    if find_broken_symlinks; then
        printf "${GREEN}%s${RESET}\n" "   ✓ No broken symlinks found"
    else
        ((issues++))
    fi
    
    # Count installed packages
    printf "\n${BOLD}%s${RESET}\n" "6. Package summary..."
    local pkg_count
    pkg_count=$(list_installed_packages | wc -l | tr -d ' ')
    printf "${CYAN}%s${RESET}\n" "   Installed packages: $pkg_count"
    
    # Final summary
    printf "\n${BOLD}%s${RESET}\n" "=== Summary ==="
    if [ "$issues" -eq 0 ]; then
        printf "${GREEN}%s${RESET}\n" "All checks passed! ✓"
    else
        printf "${YELLOW}%s${RESET}\n" "Found $issues issue(s) that need attention."
    fi
    
    exit
}

# ============================================================================
# PACKAGE INFO (NEW)
# ============================================================================

fn_info() {
    if [[ -z $1 ]]; then
        printf "${RED}%s${RESET}\n" "Specify a package name."
        exit 1
    fi
    
    local package=$1
    
    if ! is_installed "$package"; then
        printf "${YELLOW}%s${RESET}\n" "Package '$package' is not installed."
        exit 1
    fi
    
    printf "${BOLD}${CYAN}%s${RESET}\n\n" "=== Package Information: $package ==="
    
    # Read manifest if available
    local manifest
    manifest=$(read_manifest "$package" 2>/dev/null)
    
    if [[ -n "$manifest" ]]; then
        echo "$manifest" | while IFS= read -r line; do
            echo "  $line"
        done
    fi
    
    # Get package size
    printf "\n${BOLD}%s${RESET}\n" "Size:"
    printf "  %s\n" "$(get_package_size "$package")"
    
    # Get symlink info
    local symlink_path="$bin_dir/$package"
    local real_path
    real_path=$(myrealpath "$symlink_path")
    
    printf "\n${BOLD}%s${RESET}\n" "Location:"
    printf "  Symlink: %s\n" "$symlink_path"
    printf "  Target:  %s\n" "$real_path"
    
    # Check if it's a git repo
    local repo_dir="${real_path%/*}"
    if [[ -d "$repo_dir/.git" ]]; then
        cd "$repo_dir" || exit
        printf "\n${BOLD}%s${RESET}\n" "Git Info:"
        printf "  Remote: %s\n" "$(git config --get remote.origin.url 2>/dev/null || echo 'N/A')"
        printf "  Branch: %s\n" "$(git branch --show-current 2>/dev/null || echo 'N/A')"
        printf "  Last commit: %s\n" "$(git log -1 --format='%cr' 2>/dev/null || echo 'N/A')"
    fi
    
    exit
}

# ============================================================================
# ADDITIONAL FUNCTIONS
# ============================================================================

fn_add_alias() {
    local alias_name repo_name script_name
    alias_name=$1
    repo_name=$2
    script_name=$3

    if alias_check "$alias_name" >&/dev/null; then
        printf "${CYAN}%s${RESET}\n" "Creating an alias $alias_name to $repo_name/$script_name"
        create_alias "${awesome_dir}" "${repo_name}" "${script_name}" "${bin_dir}" "${alias_name}" || exit
        printf "${GREEN}%s${RESET}\n" "Alias $alias_name created."
    else
        printf "${RED}%s${RESET}\n" "You have the same alias as ${alias_name}."
        printf "${RED}%s${RESET}\n" "Use unlink to unlink the link."
    fi
}

fn_push() {
    if [[ -z $1 ]]; then
        printf "${RED}%s${RESET}\n" "Please add commit message."
        exit 1
    fi
    
    dir_path=$(pwd)
    dir_name=$(second "$dir_path")
    if [[ -L $bin_dir/$dir_name ]]; then
        branch_name=$(git branch --show-current)
        git add .
        git commit -m "$1"
        git push origin "$branch_name"
        printf "${CYAN}%s${RESET}\n" "Updating ..."
        fn_update "$dir_name"
        echo
    else
        printf "${RED}%s${RESET}\n" "Please install the script first."
        exit 1
    fi
    exit
}

fn_stats() {
    printf "${BOLD}${CYAN}%s${RESET}\n\n" "=== Awesome Statistics ==="
    
    local packages
    mapfile -t packages < <(list_installed_packages)
    local count=${#packages[@]}
    
    printf "${BOLD}%s${RESET}\n" "Total packages installed: $count"
    
    if [ "$count" -eq 0 ]; then
        exit
    fi
    
    printf "\n${BOLD}%s${RESET}\n" "Package sizes:"
    for package in "${packages[@]}"; do
        local size
        size=$(get_package_size "$package")
        printf "  %-30s %s\n" "$package" "$size"
    done
    
    exit
}

fn_help() {
    cat <<EOF
${BOLD}Awesome Package Manager v${version}${RESET}

${BOLD}DESCRIPTION:${RESET}
    Awesome installs shell script packages from GitHub repos on macOS/Linux.

${BOLD}USAGE:${RESET}
    awesome <command> [options]

${BOLD}COMMANDS:${RESET}
    install       Install a package from GitHub
    rm            Uninstall a package
    update        Update a package (or --all for all packages)
    ls            List installed packages
    link          Add a symlink to an installed package
    unlink        Remove a package symlink
    links         Show all symlinks
    alias         Create an alias to a script
    push          Git add, commit, push, and update
    
    ${BOLD}NEW COMMANDS:${RESET}
    doctor        Run health check diagnostics
    info          Show detailed package information
    stats         Show package statistics
    export        Export installed packages list
    import        Import and install from packages list
    url           Open Awesome GitHub repo

${BOLD}OPTIONS:${RESET}
    -v, --version Show version
    -h, --help    Show this help message

${BOLD}EXAMPLES:${RESET}
    ${CYAN}# Install a package${RESET}
    awesome install shinokada/gitstart
    awesome install raylee/tldr-sh-client tldr
    awesome install https://github.com/shinokada/cleanit
    
    ${CYAN}# Update packages${RESET}
    awesome update gitstart
    awesome update --all
    
    ${CYAN}# Health check${RESET}
    awesome doctor
    
    ${CYAN}# Package information${RESET}
    awesome info gitstart
    awesome stats
    
    ${CYAN}# Backup and restore${RESET}
    awesome export ~/my-packages.txt
    awesome import ~/my-packages.txt
    
    ${CYAN}# Show installed${RESET}
    awesome ls
    
    ${CYAN}# Create alias${RESET}
    awesome alias ne script-example node-example.js
    
    ${CYAN}# Git workflow${RESET}
    awesome push "commit message"

${BOLD}DOCUMENTATION:${RESET}
    https://awesome.codewithshin.com

EOF
    exit
}

# ============================================================================
# MAIN FUNCTION
# ============================================================================

fn_main() {
    if (($# > 0)); then
        case $1 in
        install) fn_install "$2" "$3" "$4";;
        rm) fn_rm "$2" ;;
        ls) symlink_names "$bin_dir" ;;
        link) fn_add_symlink "$2" "$3" ;;
        unlink) fn_remove_symlink "$2" ;;
        links) show_symlinks ;;
        update) 
            if [[ "$2" == "--all" ]]; then
                update_all_packages
                exit
            else
                fn_update "$2"
            fi
            ;;
        alias) fn_add_alias "$2" "$3" "$4" ;;
        push) fn_push "$2" ;;
        doctor) fn_doctor ;;
        info) fn_info "$2" ;;
        stats) fn_stats ;;
        export) export_packages "$2" ;;
        import) import_packages "$2" ;;
        url) open_url ;;
        -h | --help) fn_help ;;
        -v | --version) echo "${version}" ;;
        *) 
            printf "${RED}%s${RESET}\n" "Unknown command: $1"
            echo "Run 'awesome --help' for usage."
            exit 1
            ;;
        esac
    else
        fn_help
        exit
    fi
}

# Initialize
checkOrmkdir "$awesome_dir"
checkOrmkdir "$bin_dir"
check_cmd git

fn_main "$@"
